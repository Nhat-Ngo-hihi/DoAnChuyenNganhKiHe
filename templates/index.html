<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OTP - One-Time Pad Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .blurred {
      filter: blur(6px);
      user-select: none;
    }
    /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c kh·ªëi ch√≠nh thay th·∫ø space-y-4 */
    #encryptInputs > div,
    #decryptInputs > div,
    #encryptInputs > div > div,
    #decryptInputs > div > div {
      margin-bottom: 1rem; /* 16px */
    }
    /* Kho·∫£ng c√°ch gi·ªØa nh√≥m n√∫t */
    #encryptInputs > div.flex.justify-center.gap-4,
    #decryptInputs > div.flex.justify-center.gap-4 {
      margin-top: 1rem;
      margin-bottom: 1.25rem;
    }
    /* Kho·∫£ng c√°ch nh·ªè cho n√∫t ·∫®n/Hi·ªán */
    #encryptInputs h3 {
      margin-bottom: 0.5rem;
    }
    #decryptInputs textarea,
    #decryptInputs input,
    #encryptInputs input,
    #encryptInputs select {
      margin-top: 0.4rem;
    }

    /* ===== Responsive container ===== */
    .main-container {
      width: 95%;
      max-width: 1400px;  /* laptop kh√¥ng qu√° to */
      margin: 0 auto;
    }
    @media (min-width: 1024px) {
      .main-container {
        width: 85%; /* tr√™n laptop chi·∫øm 85% m√†n h√¨nh */
      }
    }
    @media (max-width: 768px) {
      .main-container {
        width: 95%; /* mobile chi·∫øm g·∫ßn h·∫øt */
        padding: 1rem;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-900 text-white flex items-center justify-center bg-fixed"
      style="background-image: url('/static/nen.jpg'); background-size:cover; background-position:center;">
  <div class="bg-black bg-opacity-60 min-h-screen p-4 sm:p-8 w-full">
    <div class="main-container bg-gray-800 bg-opacity-90 rounded-xl p-4 sm:p-8 relative shadow-lg">
      <h1 class="text-2xl sm:text-3xl text-center text-teal-300 mb-4">
        ·ª®ng d·ª•ng M√£ H√≥a & GiaÃâi MaÃÉ One-Time Pad
      </h1>

      <!-- Mode -->
      <div class="flex items-center gap-4 mb-4">
        <label class="flex items-center gap-2"><input type="radio" name="mode" value="encrypt" checked> M√£ h√≥a</label>
        <label class="flex items-center gap-2"><input type="radio" name="mode" value="decrypt"> Gi·∫£i m√£</label>
        <div class="ml-auto">
          <label class="text-sm">T√™n file xu·∫•t:</label>
          <input id="outName" class="ml-2 px-2 py-1 rounded bg-gray-700" value="result" />
          <select id="outExt" class="ml-2 px-2 py-1 rounded bg-gray-700">
            <option value="bin">bin</option>
            <option value="txt">txt</option>
            <option value="png">png</option>
            <option value="jpg">jpg</option>
            <option value="pdf">pdf</option>
            <option value="docx">docx</option>
          </select>
        </div>
      </div>

      <div>

        <!-- M√£ h√≥a: ch·ªçn file + password -->
        <div id="encryptInputs">
          <div>
            <label>Ch·ªçn file:</label>
            <input id="fileInput" type="file" class="ml-2" />
          </div>

          <div>
            <label>M·∫≠t kh·∫©u (s·∫Ω ƒë∆∞·ª£c m√£ h√≥a b·∫±ng AES ƒë·ªÉ b·∫£o v·ªá):</label>
            <input id="passwordInput" type="password" class="w-full mt-2 p-2 bg-gray-700 rounded" />
          </div>

          <div class="flex items-center gap-8">
            <div class="flex items-center gap-2">
              <label class="text-sm">Lo·∫°i kh√≥a:</label>
              <select id="keyType" class="ml-2 px-2 py-1 rounded bg-gray-700">
                <option value="integer" selected>S·ªë nguy√™n (m·∫∑c ƒë·ªãnh)</option>
              </select>
            </div>

            <div class="flex items-center gap-2">
              <input id="compression" type="checkbox" />
              <label for="compression">N√©n key (Huffman)</label>
            </div>
          </div>

          <div class="flex justify-center gap-4">
            <button id="btnAction" class="bg-teal-600 px-6 py-2 rounded">M√£ H√≥a</button>
            <button id="btnExport" class="bg-yellow-600 px-4 py-2 rounded">Xu·∫•t Key + Log</button>
            <button id="btnClear" class="bg-gray-600 px-4 py-2 rounded">X√≥a log</button>
          </div>

          <div>
            <h3 class="font-semibold flex items-center gap-4">
              Kh√≥a ƒë∆∞·ª£c t·∫°o (hex):
              <button id="toggleKey" class="text-xs bg-gray-700 px-2 py-1 rounded hover:bg-gray-600">·∫®n/Hi·ªán</button>
            </h3>
            <pre id="keyHex" class="bg-gray-700 p-3 rounded h-20 overflow-auto text-sm"></pre>
          </div>

          <div>
            <h3 class="font-semibold flex items-center gap-4">
              AES (enc_pass) m√£ h√≥a kh√≥a OTP (key):
              <button id="toggleEncPass" class="text-xs bg-gray-700 px-2 py-1 rounded hover:bg-gray-600">·∫®n/Hi·ªán</button>
            </h3>
            <pre id="encPassHex" class="bg-gray-700 p-3 rounded h-20 overflow-auto text-sm"></pre>
          </div>
        </div>

        <!-- Gi·∫£i m√£: upload file m√£ h√≥a + nh·∫≠p password + nh·∫≠p key hex + AES hex -->
        <div id="decryptInputs" class="hidden">
          <div>
            <label>Ch·ªçn file m√£ h√≥a:</label>
            <input id="decryptFileInput" type="file" class="ml-2" />
          </div>

          <div>
            <label>M·∫≠t kh·∫©u (nh·∫≠p ƒë·ªÉ gi·∫£i m√£):</label>
            <input id="decryptPasswordInput" type="password" class="w-full mt-2 p-2 bg-gray-700 rounded" />
          </div>

          <div>
            <label>Nh·∫≠p key hex:</label>
            <textarea id="decryptKeyHex" rows="2" class="w-full mt-1 p-2 bg-gray-700 rounded text-xs font-mono" placeholder="D√°n key hex ·ªü ƒë√¢y"></textarea>
          </div>

          <div>
            <label>Nh·∫≠p AES (enc_pass) hex:</label>
            <textarea id="decryptEncPassHex" rows="2" class="w-full mt-1 p-2 bg-gray-700 rounded text-xs font-mono" placeholder="D√°n AES enc_pass hex ·ªü ƒë√¢y"></textarea>
          </div>

          <div class="flex justify-center gap-4">
            <button id="btnDecrypt" class="bg-teal-600 px-6 py-2 rounded">Gi·∫£i M√£</button>
            <button id="btnClearDecrypt" class="bg-gray-600 px-4 py-2 rounded">X√≥a log</button>
          </div>
        </div>

        <div>
          <h3 class="font-semibold">Log / Th√¥ng b√°o:</h3>
          <div id="log" class="bg-gray-700 p-3 rounded h-40 overflow-auto text-sm whitespace-pre-line"></div>
          <div class="mt-2 text-xs text-gray-400 text-right">
            Ng√¥ T·∫•n Nh·∫≠t - Nguy·ªÖn L·ªôc Ph√°t - Nguy·ªÖn Qu·ªëc Th·∫Øng
          </div>
        </div>

        <!-- Preview ·∫£nh -->
        <div id="previewContainer" class="hidden mt-4">
          <h3 class="font-semibold">Xem tr∆∞·ªõc ·∫£nh:</h3>
          <img id="previewImage" src="" alt="Preview" class="mt-2 max-w-full rounded shadow-lg border border-gray-500" />
        </div>

      </div>
    </div>
  </div>

<script>
function validatePassword() {
    const password = document.getElementById("password").value;
    const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{6,}$/;

    if (!regex.test(password)) {
        alert("‚ùå M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±, g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng v√† k√Ω t·ª± ƒë·∫∑c bi·ªát!");
        return false; // ch·∫∑n g·ª≠i form
    }
    return true;
}
const modeRadios = document.querySelectorAll('input[name="mode"]');
const encryptInputs = document.getElementById('encryptInputs');
const decryptInputs = document.getElementById('decryptInputs');
const keyHexPre = document.getElementById('keyHex');
const encPassHexPre = document.getElementById('encPassHex');
const logDiv = document.getElementById('log');
const previewContainer = document.getElementById('previewContainer');
const previewImage = document.getElementById('previewImage');

function log(msg) {
  logDiv.innerText += msg + "\n";
  logDiv.scrollTop = 1e9;
}

function clearLog() {
  logDiv.innerText = '';
}

function base64ToUint8Array(b64) {
  const binStr = atob(b64);
  const len = binStr.length;
  const arr = new Uint8Array(len);
  for (let i=0; i<len; i++) arr[i] = binStr.charCodeAt(i);
  return arr;
}

function downloadBinaryFromBase64(b64, filename) {
  const arr = base64ToUint8Array(b64);
  const blob = new Blob([arr], {type: 'application/octet-stream'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
}

function downloadTextFile(text, filename) {
  const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
}

function showPreviewIfImage(b64, ext) {
  ext = ext.toLowerCase();
  if (ext === "png" || ext === "jpg" || ext === "jpeg") {
    previewImage.src = `data:image/${ext};base64,${b64}`;
    previewContainer.classList.remove("hidden");
  } else {
    previewContainer.classList.add("hidden");
    previewImage.src = '';
  }
}

function toggleBlur(element) {
  if (element.classList.contains('blurred')) {
    element.classList.remove('blurred');
  } else {
    element.classList.add('blurred');
  }
}

modeRadios.forEach(radio => {
  radio.addEventListener('change', () => {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    clearLog();
    keyHexPre.innerText = '';
    encPassHexPre.innerText = '';
    previewContainer.classList.add('hidden');
    previewImage.src = '';

    if (mode === 'encrypt') {
      encryptInputs.classList.remove('hidden');
      decryptInputs.classList.add('hidden');
      document.getElementById('btnAction').innerText = 'M√£ H√≥a';
      document.getElementById('outExt').value = 'bin';
    } else {
      encryptInputs.classList.add('hidden');
      decryptInputs.classList.remove('hidden');
      document.getElementById('btnAction').innerText = 'Gi·∫£i M√£';
      document.getElementById('outExt').value = 'png';
    }
  });
});

// Toggle kh√≥a hex v√† AES hex m·ªù/hi·ªán
document.getElementById('toggleKey').addEventListener('click', () => {
  toggleBlur(keyHexPre);
});
document.getElementById('toggleEncPass').addEventListener('click', () => {
  toggleBlur(encPassHexPre);
});

// Xu·∫•t file key + log
document.getElementById('btnExport').addEventListener('click', () => {
  const key = keyHexPre.innerText.trim() || '(empty)';
  const encPass = encPassHexPre.innerText.trim() || '(empty)';
  const logText = logDiv.innerText.trim() || '';
  const content = `Key (hex):\n${key}\n\nAES enc_pass (hex):\n${encPass}\n\nLog:\n${logText}\n`;
  downloadTextFile(content, 'key_and_log.txt');
  log('‚úÖ ƒê√£ xu·∫•t file key_and_log.txt');
});

// M√£ h√≥a
document.getElementById('btnAction').addEventListener('click', async () => {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  if (mode === 'encrypt') {
    const file = document.getElementById('fileInput').files[0];
    const password = document.getElementById('passwordInput').value;
    const compress = document.getElementById('compression').checked;
    const outName = document.getElementById('outName').value || 'result';
    const outExt = document.getElementById('outExt').value || 'bin';

    if (!file) return log("‚ö†Ô∏è Ch∆∞a ch·ªçn file.");
    if (!password) return log("‚ö†Ô∏è Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u.");

    const b64 = await readFileAsBase64(file);
    log("üîê G·ª≠i request m√£ h√≥a...");
    try {
      const res = await fetch('/encrypt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({file: b64, password, compress, outExt})
      });
      const data = await res.json();
      if (data.error) { log("‚ùå " + data.error); return; }
      if (data.key_hex) keyHexPre.innerText = data.key_hex;
      if (data.enc_pass_hex) encPassHexPre.innerText = data.enc_pass_hex;

      const filename = `${outName}.${outExt}`;
      downloadBinaryFromBase64(data.encrypted_data, filename);
      log(`‚úÖ M√£ h√≥a xong ‚Äî file ƒë√£ t·∫£i v·ªÅ (${filename}).`);
    } catch (e) {
      log(`‚ùå L·ªói: ${e.message}`);
    }
  }
});

// Gi·∫£i m√£
document.getElementById('btnDecrypt').addEventListener('click', async () => {
  const decryptFile = document.getElementById('decryptFileInput').files[0];
  const password = document.getElementById('decryptPasswordInput').value;
  const keyHexText = document.getElementById('decryptKeyHex').value.trim();
  const encPassHexText = document.getElementById('decryptEncPassHex').value.trim();
  const outName = document.getElementById('outName').value || 'result';
  const outExt = document.getElementById('outExt').value || 'bin';

  if (!decryptFile) return log("‚ö†Ô∏è Ch∆∞a ch·ªçn file m√£ h√≥a.");
  if (!keyHexText || !encPassHexText) {
    return log("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß key hex v√† AES enc_pass hex.");
  }
  if (!password) return log("‚ö†Ô∏è Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u.");

  // ƒê·ªçc file m√£ h√≥a
  const decryptFileB64 = await readFileAsBase64(decryptFile);

  log("üîì G·ª≠i request gi·∫£i m√£...");
  try {
    const res = await fetch('/decrypt', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        file: decryptFileB64,
        password,
        key_hex: keyHexText,
        enc_pass_hex: encPassHexText,
        outExt
      })
    });
    const data = await res.json();
    if (data.error) {
      log("‚ùå " + data.error);
      return;
    }
    const filename = `${outName}.${outExt}`;
    downloadBinaryFromBase64(data.original_file, filename);
    log(`‚úÖ Gi·∫£i m√£ xong ‚Äî file ƒë√£ t·∫£i v·ªÅ (${filename}).`);
    showPreviewIfImage(data.original_file, outExt);
  } catch (e) {
    log(`‚ùå L·ªói: ${e.message}`);
  }
});

// Clear c·∫£ m√£ h√≥a v√† gi·∫£i m√£
document.getElementById('btnClearDecrypt').addEventListener('click', () => {
  clearLog();
  keyHexPre.innerText = '';
  encPassHexPre.innerText = '';
  previewContainer.classList.add('hidden');
  previewImage.src = '';
  // X√≥a lu√¥n input gi·∫£i m√£
  document.getElementById('decryptFileInput').value = '';
  document.getElementById('decryptPasswordInput').value = '';
  document.getElementById('decryptKeyHex').value = '';
  document.getElementById('decryptEncPassHex').value = '';
});

// H√†m ƒë·ªçc file base64 (d√πng chung)
async function readFileAsBase64(file) {
  const ab = await file.arrayBuffer();
  let binary = '';
  const bytes = new Uint8Array(ab);
  for (let i=0; i<bytes.length; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
</script>
</body>
</html>
